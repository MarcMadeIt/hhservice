name: Deploy Next.js to Hostinger VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted # ✅ This ensures it runs on your self-hosted VPS runner
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🏗 Install dependencies
        run: npm install

      - name: 🔧 Build Next.js project
        run: |
          echo "⚡ Cleaning up old builds..."
          rm -rf .next
          echo "⚡ Building Next.js project..."
          npm run build

      - name: 🚀 Restart PM2
        run: |
          echo "🔄 Restarting PM2..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # Loads NVM correctly

          cd /var/www/my-nextjs-app || exit 1
          npm install --production

          echo "⚡ Restarting PM2 process..."
          pm2 restart nextjs-app || pm2 start npm --name "nextjs-app" -- start
          pm2 save
          pm2 list

      - name: ✅ Deployment completed
        run: echo "🚀 Deployment successful!"
