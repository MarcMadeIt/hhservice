name: Deploy Next.js to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ”„ Reset & Pull Latest Code from GitHub
        run: |
          echo "âš ï¸ Resetting repository and pulling latest code..."
          cd /home/marccode/htdocs/hhs.marccode.com
          git fetch --all
          git reset --hard origin/main
          git pull origin main --force

      - name: ğŸ›  Remove old Next.js & dependencies
        run: |
          echo "âš ï¸ Removing old dependencies and Next.js cache..."
          cd /home/marccode/htdocs/hhs.marccode.com
          rm -rf node_modules package-lock.json .next
          npm install

      - name: ğŸ”§ Build Next.js project
        run: |
          echo "âš¡ Building Next.js app..."
          cd /home/marccode/htdocs/hhs.marccode.com
          npm run build

      - name: ğŸš€ Restart PM2 with `npm run start`
        run: |
          echo "ğŸ”„ Restarting PM2 with Production Mode..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # Loads NVM correctly

          cd /home/marccode/htdocs/hhs.marccode.com
          npm install --production

          echo "âš¡ Restarting PM2 process with npm run start..."
          pm2 delete hhs-marccode || true  # âœ… Ensures old process is removed
          pm2 start npm --name "hhs-marccode" -- start -- -p 3030  # âœ… Runs in production mode on port 3030
          pm2 save
          pm2 list

      - name: âœ… Deployment completed
        run: echo "ğŸš€ Deployment successful!"
